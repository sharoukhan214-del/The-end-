<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>منصة محمد 2026 - ULTRA SYSTEM</title>
<style>
body{margin:0;font-family:Segoe UI;background:#0b0f1a;color:#f8fafc;padding-bottom:90px}
header{background:#1e293b;padding:15px;font-weight:900;color:#f59e0b;text-align:center;position:sticky;top:0;z-index:100}
.screen{display:none;padding:15px}
.active{display:block}
.card{background:#1e293b;padding:15px;border-radius:12px;margin-bottom:10px}
.btn{background:#f59e0b;color:#000;border:none;padding:12px;border-radius:10px;width:100%;font-weight:bold;margin-top:5px;cursor:pointer}
input,select,textarea{width:100%;padding:10px;border-radius:8px;border:none;margin:6px 0;background:#0f172a;color:white}
.nav{position:fixed;bottom:0;width:100%;background:#1e293b;display:none;justify-content:space-around;padding:10px}
.nav div{text-align:center;font-size:12px;cursor:pointer;color:#94a3b8}
.nav-active{color:#f59e0b !important}
.msg{padding:10px;border-radius:12px;max-width:80%;margin-bottom:5px;word-break:break-word}
.sent{background:#f59e0b;color:#000;margin-left:auto}
.received{background:#334155;margin-right:auto}
</style>
</head>
<body>

<header id="logo">PRO منصة محمد</header>

<!-- AUTH -->
<div id="auth" class="screen active">
<input id="phone" placeholder="رقم الموبايل">
<select id="role">
<option value="client">عميل</option>
<option value="worker">صنايعي</option>
</select>
<select id="skill">
<option>سباك</option><option>كهربائي</option><option>نجار</option>
</select>
<button class="btn" onclick="login()">دخول</button>
</div>

<!-- CLIENT -->
<div id="client" class="screen">
<div class="card">
<h3>نشر طلب جديد</h3>
<textarea id="desc" placeholder="وصف المشكلة"></textarea>
<input id="price" type="number" placeholder="الميزانية">
<button class="btn" onclick="postJob()">نشر</button>
</div>
<div id="clientJobs"></div>
</div>

<!-- WORKER -->
<div id="worker" class="screen">
<div class="card">
رصيدك: <b id="workerBalance">0</b> ج  
<button class="btn" onclick="withdraw()">طلب سحب</button>
</div>
<h3>الطلبات المتاحة</h3>
<div id="workerJobs"></div>
</div>

<!-- CHAT -->
<div id="chat" class="screen">
<h3>الدردشة</h3>
<div id="chatBox" style="height:50vh;overflow-y:auto;margin-bottom:10px;"></div>
<input id="msg" placeholder="اكتب هنا..">
<button class="btn" onclick="sendMsg()">إرسال</button>
</div>

<!-- ADMIN -->
<div id="admin" class="screen">
<div class="card">
<b>لوحة تحكم الأدمن</b><br>
إجمالي أرباح المنصة: <span id="adminProfit">0</span> ج
</div>
<h3>طلبات السحب</h3>
<div id="withdrawRequests"></div>
</div>

<div class="nav" id="nav">
<div onclick="home()">الرئيسية</div>
<div onclick="showChat()">الدردشة</div>
<div onclick="logout()" style="color:#ef4444">خروج</div>
</div>

<script>
const COMMISSION = 0.20;
let adminClicks=0;
let adminPass="Mohamed214@";
let currentJobId=null;

let state=JSON.parse(localStorage.getItem("state"))||{
  users:{},jobs:[],msgs:[],withdraws:[],profit:0
};
let user=null;

// ADMIN access on logo triple click
logo.onclick=()=>{
  adminClicks++;
  setTimeout(()=>adminClicks=0,1500);
  if(adminClicks==3){
    let p=prompt("كلمة مرور الأدمن");
    if(p===adminPass){show("admin");renderAdmin();nav.style.display="flex";}
  }
}

// Save state
function save(){localStorage.setItem("state",JSON.stringify(state));}

// LOGIN
function login(){
  let ph=phone.value.trim();
  if(!ph){alert("أدخل رقم الهاتف"); return;}
  if(!state.users[ph]){
    state.users[ph]={role:role.value,skill:skill.value,balance:0};
  }
  user={ph};
  save();home();
}

// HOME
function home(){
  nav.style.display="flex";
  let r=state.users[user.ph].role;
  show(r);
  render();
}

// SHOW SCREEN
function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// POST JOB
function postJob(){
  let d=desc.value.trim(), p=+price.value;
  if(!d || !p){alert("املأ كل الحقول"); return;}
  state.jobs.push({id:Date.now(),client:user.ph,desc:d,price:p,status:"open",offers:[]});
  desc.value=""; price.value="";
  save(); render();
}

// RENDER CLIENT / WORKER
function render(){
  let role=state.users[user.ph].role;
  if(role==="client"){
    clientJobs.innerHTML=state.jobs.filter(j=>j.client===user.ph)
    .map(j=>`
      <div class="card">
        ${j.desc}<br>
        ${j.offers.map(o=>`
          <div>عرض ${o.price} ج 
          <button onclick="accept(${o.jobId||j.id},'${o.ph}',${o.price})">قبول</button></div>`).join("")}
      </div>
    `).join("");
  }else{
    workerBalance.innerText=state.users[user.ph].balance;
    workerJobs.innerHTML=state.jobs.filter(j=>j.status==="open" && j.type===state.users[user.ph].skill)
    .map(j=>`
      <div class="card">
        ${j.desc} - ${j.price} ج
        <button onclick="offer(${j.id})">تقديم عرض</button>
      </div>
    `).join("");
  }
}

// WORKER OFFER
function offer(id){
  let j=state.jobs.find(j=>j.id==id);
  let p=prompt("سعرك");
  if(!p) return;
  j.offers.push({ph:user.ph,price:+p});
  save(); render();
}

// ACCEPT OFFER
function accept(id,ph,price){
  let j=state.jobs.find(j=>j.id==id);
  let fee=Math.round(price*COMMISSION);
  let net=price-fee;
  j.worker=ph; j.final=price; j.platformFee=fee; j.workerNet=net; j.status="work";
  state.users[ph].balance+=net;
  state.profit+=fee;
  currentJobId=j.id;
  save(); show("chat");
}

// CHAT
function sendMsg(){
  if(!currentJobId){alert("لا يوجد شغل جاري"); return;}
  state.msgs.push({job:currentJobId,from:user.ph,text:msg.value});
  msg.value="";
  save(); showChat();
}

function showChat(){
  if(!currentJobId){chatBox.innerHTML="لا يوجد دردشة"; return;}
  let j=state.jobs.find(j=>j.id===currentJobId);
  chatBox.innerHTML=state.msgs.filter(m=>m.job===j.id)
    .map(m=>`<div class="msg ${m.from===user.ph?'sent':'received'}">${m.text}</div>`).join("");
  chatBox.scrollTop=chatBox.scrollHeight;
}

// WORKER WITHDRAW
function withdraw(){
  let bal=state.
